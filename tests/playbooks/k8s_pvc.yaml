---
- name: Create a persistent volume claim
  hosts: localhost
  connection: local
  tasks:
    - name: Create PVC pvc-demo with external 
      k8s:
       state: present
       namespace: default
       name: pvc-demo
       inline:
         apiVersion: v1
         kind: PersistentVolumeClaim
         metadata:
           name: pvc-demo
           labels:
             app: containerized-data-importer
           annotations:
             cdi.kubevirt.io/storage.import.endpoint: "https://dl.fedoraproject.org/pub/fedora/linux/releases/31/Cloud/x86_64/images/Fedora-Cloud-Base-31-1.9.x86_64.qcow2"
             kubevirt.io/provisionOnNode : "{{ node_name }}"
         spec:
           storageClassName: "{{ storage_provisioner }}"
           accessModes:
           - ReadWriteOnce
           resources:
             requests:
               storage: 5Gi

    - name: Wait for PVC to be ready
      k8s_facts:
        name: pvc-demo
        namespace: default
        kind: PersistentVolumeClaim
        api_version: v1
      register: pvc
      until: "pvc.resources[0].status.phase == 'Bound' and pvc.resources[0].metadata.annotations['cdi.kubevirt.io/storage.pod.phase'] == 'Succeeded'"
      delay: 10
      retries: 10
